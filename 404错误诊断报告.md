# Tomcat 外联式部署 404 错误诊断报告

## 问题概述
在将塔罗牌Web应用部署到外部Tomcat 11.0.11服务器后，出现404错误。

## 检查发现的问题

### 1. ✅ **主要问题已解决：API路径配置**

**问题位置**：`src/main/webapp/js/tarot-game.js` 第215行

**原问题代码**：
```javascript
const response = await fetchWithCancel('./api/cards');
```

**问题原因**：
- 使用相对路径 `'./api/cards'` 在部署到Tomcat后，可能无法正确解析应用的上下文路径
- 当应用部署在 `/tarot` 上下文路径下时，需要包含完整的上下文路径

**解决方案**（已修复）：
```javascript
// 获取当前应用的上下文路径
const contextPath = window.location.pathname.substring(0, window.location.pathname.indexOf('/', 1)) || '';
const response = await fetchWithCancel(`${contextPath}/api/cards`);
```

### 2. ✅ **已解决：pom.xml中的路径分隔符问题**

**问题位置**：`pom.xml` 第98行

**原问题代码**：
```xml
<webXml>src\main\webapp\WEB-INF\web.xml</webXml>
```

**问题原因**：
- 使用Windows风格的反斜杠 `\` 作为路径分隔符
- 在Linux/Unix环境下可能导致路径解析错误
- 虽然Maven通常能处理这种差异，但最佳实践是使用正斜杠

**解决方案**（已修复）：
```xml
<webXml>src/main/webapp/WEB-INF/web.xml</webXml>
```

### 3. ℹ️ **非关键问题：/@vite/client 404错误**

**问题表现**：
访问日志中多次出现：
```
GET /@vite/client HTTP/1.1" 404 717
```

**问题原因**：
- 这是开发环境（Vite开发服务器）的残留引用
- 不影响生产环境的实际功能
- 来自浏览器缓存或IDE的webview请求

**建议**：
- 可以忽略，不影响应用运行
- 如需彻底清除，清理浏览器缓存即可

## 配置验证

### ✅ 正确的配置项

1. **web.xml配置正确**：
   - Servlet映射：`/api/*` ✓
   - 欢迎文件：`index.html` ✓
   - 上下文初始化监听器已配置 ✓

2. **部署结构正确**：
   ```
   apache-tomcat-11.0.11/
   └── webapps/
       └── tarot/
           ├── index.html
           ├── css/
           ├── js/
           ├── images/
           ├── WEB-INF/
           │   ├── web.xml
           │   ├── classes/
           │   └── lib/
           └── META-INF/
   ```

3. **访问日志显示大部分请求成功**：
   - `GET /tarot/` → 200 ✓
   - `GET /tarot/api/cards` → 200 ✓
   - `GET /tarot/css/tarot-styles.css` → 200 ✓
   - `GET /tarot/js/tarot-game.js` → 200 ✓
   - `GET /tarot/images/卡牌背面.png` → 200 ✓

## 修复后的测试步骤

1. **重新编译打包**：
   ```bash
   mvn clean package
   ```

2. **部署到Tomcat**：
   - 将生成的 `target/tarot.war` 复制到 `apache-tomcat-11.0.11/webapps/`
   - Tomcat会自动解压并部署

3. **访问测试**：
   ```
   http://localhost:8080/tarot/
   ```

4. **验证API调用**：
   打开浏览器开发者工具（F12），检查Network标签：
   - 应该看到 `GET /tarot/api/cards` 返回 200
   - 响应内容应包含塔罗牌数据

## 总结

### 已修复的关键问题：
1. ✅ JavaScript中的API路径现在能正确适配应用的上下文路径
2. ✅ pom.xml中的路径分隔符已统一为正斜杠

### 应用现在应该能够：
- ✓ 正确加载首页
- ✓ 成功调用后端API获取塔罗牌数据
- ✓ 在所有操作系统（Windows/Linux/macOS）上正常工作

### 注意事项：
- 如果问题仍然存在，请检查：
  1. Tomcat是否正常启动
  2. 端口8080是否被占用
  3. 防火墙设置是否阻止访问
  4. 浏览器控制台是否有其他错误信息

---
**诊断完成时间**：2025-10-17
**Tomcat版本**：11.0.11
**Java版本**：OpenJDK 25
