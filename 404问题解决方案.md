# 🔍 HTTP 404 问题诊断与解决方案

## 📊 问题现象

访问 `http://localhost:8080/tarot/` 时出现 **HTTP 404 - 未找到** 错误。

---

## 🎯 问题根源

### ❌ 主要问题：`src/main/webapp/WEB-INF/lib` 目录包含 Tomcat jar 包

**发现过程**：

1. 检查 `target/tarot/WEB-INF/lib` 发现包含 47 个 jar 包
2. 这些 jar 包包括：
    - `catalina.jar`
    - `tomcat-*.jar`
    - `servlet-api.jar`
    - 等大量 Tomcat 内部 jar 包

**问题原因**：

-   Maven 打包 WAR 时，会将 `src/main/webapp/WEB-INF/lib` 下的所有 jar 包打包进去
-   这些 Tomcat jar 包与外部 Tomcat 服务器的 jar 包产生**类加载冲突**
-   导致应用无法正常启动，返回 404 错误

---

## ✅ 解决方案

### 1️⃣ 删除冲突的 lib 目录

```bash
# 删除源代码中的lib目录（外联Tomcat不需要）
Remove-Item -Recurse -Force src\main\webapp\WEB-INF\lib
```

**原理**：

-   外联 Tomcat 部署时，Tomcat 会自动提供所有运行时依赖
-   `WEB-INF/lib` 应该只包含**应用特定的依赖**（如 Jackson、Logback）
-   Maven 会根据 `pom.xml` 自动将这些依赖打包到 WAR 中

### 2️⃣ 删除 IDEA 的 lib 库配置

```bash
# 删除IDEA配置文件
delete .idea/libraries/lib.xml
```

**lib.xml 内容**（问题配置）：

```xml
<library name="lib">
  <CLASSES>
    <root url="file://$PROJECT_DIR$/src/main/webapp/WEB-INF/lib" />
  </CLASSES>
</library>
```

### 3️⃣ 重新打包部署

```bash
# 清理并重新打包
mvn clean package -DskipTests

# 部署到Tomcat
copy target\tarot.war apache-tomcat-11.0.11\webapps\
```

---

## 📦 正确的 WAR 包结构

### ✅ 修复后的 lib 目录（只有 7 个 jar）

```
target/tarot/WEB-INF/lib/
├── jackson-annotations-2.18.0.jar      # JSON处理
├── jackson-core-2.18.0.jar             # JSON处理
├── jackson-databind-2.18.0.jar         # JSON处理
├── jackson-datatype-jsr310-2.18.0.jar  # Java 8日期支持
├── logback-classic-1.5.8.jar           # 日志框架
├── logback-core-1.5.8.jar              # 日志框架
└── slf4j-api-2.0.16.jar                # 日志接口
```

### ❌ 修复前的 lib 目录（47 个 jar - 错误！）

包含了不应该存在的 jar 包：

-   `catalina.jar`, `catalina-ant.jar`, `catalina-ha.jar`
-   `tomcat-embed-*.jar`（嵌入式 Tomcat 相关）
-   `servlet-api.jar`（应由 Tomcat 提供）
-   等等...

---

## 🔧 技术细节

### Jakarta EE 与 OpenJDK 25 兼容性

✅ **完全兼容**

| 组件                | 版本    | 兼容性                |
| ------------------- | ------- | --------------------- |
| Jakarta Servlet API | 6.1.0   | ✅ 支持               |
| Apache Tomcat       | 11.0.11 | ✅ 支持 Jakarta EE 10 |
| OpenJDK             | 25      | ✅ 完全支持           |
| Jackson             | 2.18.0  | ✅ 支持               |

**Tomcat 11.0.11 说明**：

-   实现 Jakarta Servlet 6.0 规范
-   需要 Java 17 或更高版本
-   **完全支持 OpenJDK 25**

### 类加载冲突原理

```
Tomcat类加载器层次:
    Bootstrap ClassLoader
           ↓
    System ClassLoader
           ↓
    Common ClassLoader (Tomcat/lib/*.jar)
           ↓
    WebApp ClassLoader (WEB-INF/lib/*.jar)
```

**冲突场景**：

1. `WEB-INF/lib` 包含 `servlet-api.jar`
2. Tomcat/lib 也包含 `servlet-api.jar`
3. WebApp ClassLoader 优先加载自己的版本
4. 但实际运行时需要与 Tomcat 的版本一致
5. **结果：类加载冲突 → 应用无法启动 → 404 错误**

---

## 🎯 依赖管理最佳实践

### pom.xml 配置要点

```xml
<dependencies>
    <!-- Servlet API - 外部Tomcat提供 -->
    <dependency>
        <groupId>jakarta.servlet</groupId>
        <artifactId>jakarta.servlet-api</artifactId>
        <version>6.1.0</version>
        <scope>provided</scope>  <!-- ⭐ 关键：provided scope -->
    </dependency>

    <!-- 应用特定依赖 - compile scope -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.18.0</version>
        <scope>compile</scope>  <!-- ⭐ 会打包进WAR -->
    </dependency>
</dependencies>
```

**scope 说明**：

-   `provided`：编译时需要，运行时由容器提供（不打包进 WAR）
-   `compile`：编译和运行时都需要（打包进 WAR 的 WEB-INF/lib）
-   `test`：仅测试时需要（不打包）

---

## 📝 验证清单

### ✅ 部署前检查

-   [ ] `src/main/webapp/WEB-INF/lib` 目录不存在
-   [ ] `mvn dependency:tree` 不包含嵌入式 Tomcat 依赖
-   [ ] `target/tarot/WEB-INF/lib` 只包含应用特定 jar 包
-   [ ] `pom.xml` 中 Servlet API 的 scope 为`provided`

### ✅ 部署后检查

```bash
# 1. 检查Tomcat日志
Get-Content apache-tomcat-11.0.11\logs\catalina.*.log -Tail 50

# 期望看到：
# "web应用程序存档文件[...tarot.war]的部署已在[xxxx]ms内完成"

# 2. 检查部署目录
dir apache-tomcat-11.0.11\webapps\tarot\WEB-INF\lib

# 期望：只有7个jar包（Jackson、Logback、SLF4J）

# 3. 访问测试
# http://localhost:8080/tarot/
# http://localhost:8080/tarot/api/cards
```

---

## 🚀 现在应该可以正常访问了！

### 测试 URL

-   ✅ 主页：http://localhost:8080/tarot/
-   ✅ API：http://localhost:8080/tarot/api/cards
-   ✅ 大阿卡纳：http://localhost:8080/tarot/api/major-arcana

### 期望结果

1. **主页** 显示塔罗牌游戏界面
2. **API** 返回 JSON 格式的卡牌数据
3. **没有 404 错误**

---

## 🔍 后续排查（如果仍有问题）

### 检查应用初始化

```bash
# 查看完整日志，找ApplicationContext初始化错误
Get-Content apache-tomcat-11.0.11\logs\catalina.*.log | Select-String "tarot|ERROR|Exception"
```

### 检查 Servlet 映射

确认 `web.xml` 中的配置：

```xml
<servlet-mapping>
    <servlet-name>TarotGameController</servlet-name>
    <url-pattern>/api/*</url-pattern>  <!-- ⭐ API路径 -->
</servlet-mapping>

<welcome-file-list>
    <welcome-file>index.html</welcome-file>  <!-- ⭐ 主页 -->
</welcome-file-list>
```

---

## 📚 相关文档

-   [外联部署配置完成说明.md](外联部署配置完成说明.md)
-   [IDEA_TOMCAT_CONFIG.md](IDEA_TOMCAT_CONFIG.md)
-   [README.md](README.md)

---

**✨ 问题已解决！现在您的应用应该可以正常访问了。**

如有其他问题，请检查 Tomcat 日志中的详细错误信息。
